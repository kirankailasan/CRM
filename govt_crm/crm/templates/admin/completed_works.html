{% load custom_tags %}
{% load static %}


<html>
    <head> 
        <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="{% static 'css/completed_works.css' %}">
        <style>

        </style>
        <!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<!-- jQuery + DataTables JS -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    </head>
    <body>
        {% include 'navbar.html' %}
        <div id="completed_works" style=" margin-top: 100px; margin-bottom: 100px">



            {% if submitted_data %}
            <table id="submittedTable" class="table table-bordered">
                <thead>
                    <tr>
                      <th id="noHeader">No</th>
                      <th id="userNameHeader">User Name</th>
                      <th id="emailHeader">Email</th>
                      <th id="districtHeader">District</th>
                      <th id="talukaNameHeader">Taluka Name</th>
                      <th id="gramPanchayatHeader">Gram Panchayat</th>
                      <th id="submittedOnHeader">Submitted on</th>
                      <th id="viewHeader">View</th>
                      <th id="downloadHeader">Download</th>
                      <th id="editHeader">Edit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in submitted_data %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ entry.user.get_full_name|default:entry.user.username }}</td>
                        <td>{{ entry.user.email }}</td>
                        <td>{{ entry.form2_data|get_item:"district" }}</td>
                        <td>{{ entry.form1_data|get_item:"taluka-name" }}</td>
                        <td>{{ entry.form1_data|get_item:"gram-panchayat-name" }}</td>
                        <td>{{ entry.created_at}}</td>
                        <td>
                            <button onclick="viewFormData('{{ entry.id }}')" class="btn btn-primary btn-sm">View</button>
                        </td>
                        <td style="position:relative;">
                            <button class="btn btn-success btn-sm" onclick="toggleDownloadMenu(event, '{{ entry.id }}')" title="Download">
                                üì•
                            </button>
                            <div id="download-menu-{{ entry.id }}" class="download-menu" style="display:none; position:absolute; z-index:10; background:#fff; border:1px solid #ccc; border-radius:4px; min-width:120px;">
                                <a href="{% url 'download_form_pdf' entry.id %}" target="_blank" style="display:block; padding:8px 12px; text-decoration:none; color:#333;">PDF</a>
                                <a href="{% url 'download_form_excel' entry.id %}" target="_blank" style="display:block; padding:8px 12px; text-decoration:none; color:#333;">Excel</a>
                            </div>
                        </td>
                        <td style="position: relative;">
                            <a href="{% url 'edit_form' entry.id%}" >üìù</a>
                           
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% else %}
            <p>No completed/submitted forms found.</p>
            {% endif %}
        </div>
            <div id="formModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.7); z-index: 1000;">
                <div class="modal-content" style="background: #fff; padding: 30px; width: 90%; height: 90%; margin: 40px auto; overflow-y: auto; position: relative; border-radius: 10px;">
                    <span class="close" onclick="closeModal()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size: 24px;">&times;</span>
                    <div id="formContainer"></div>
                </div>
            </div>


        <script>
          /**
           * Fetch form data and display it in the modal
           * @param {string} formId - The ID of the form entry
           */
          function viewFormData(formId) {
              fetch(`/view-form-popup/${formId}/`, {
                  method: "GET",
                  headers: {
                      "X-Requested-With": "XMLHttpRequest"
                  }
              })
              .then(response => response.json()) 
              .then(data => {
                  if (data.html) {
                      // Inject HTML into the modal container
                      document.getElementById('formContainer').innerHTML = data.html;
                      document.getElementById('formModal').style.display = 'block';
      
                      // Apply translations to the popup form
                      const userLanguage = localStorage.getItem('selectedLanguage') || 'en';
                      loadTranslations(userLanguage, 'submitted_form');  // Trigger translation for the form
                  } else if (data.error) {
                      alert(data.error);
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  alert("Error loading form data.");
              });
          }
      
          /**
           * Close the modal
           */
          function closeModal() {
              document.getElementById('formModal').style.display = 'none';
          }
      
          // Optional: Close modal when clicking outside content
          window.onclick = function(event) {
              var modal = document.getElementById('formModal');
              if (event.target == modal) {
                  modal.style.display = 'none';
              }
          }
      
          /**
           * Toggle the visibility of a form section
           * @param {string} id - The ID of the form section
           * @param {string} iconId - The ID of the toggle icon
           */
          function toggleForm(id, iconId) {
              const section = document.getElementById(id);
              const icon = document.getElementById(iconId);
              if (section.style.display === "none") {
                  section.style.display = "block";
                  icon.innerText = "‚ñº";
              } else {
                  section.style.display = "none";
                  icon.innerText = "‚ñ∂";
              }
          }
      </script>
      

<script>
    function toggleDownloadMenu(event, entryId) {
        event.stopPropagation();
        // Hide any other open menus
        document.querySelectorAll('.download-menu').forEach(menu => menu.style.display = 'none');
        // Show the clicked menu
        var menu = document.getElementById('download-menu-' + entryId);
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }
    // Hide menu when clicking outside
    document.addEventListener('click', function() {
        document.querySelectorAll('.download-menu').forEach(menu => menu.style.display = 'none');
    });
</script>



<script>
    $(document).ready(function () {
        $('#submittedTable').DataTable({
            pageLength: 10,
            order: [[0, 'asc']], // Default sort by "No"
            columnDefs: [
                { orderable: false, targets: [7, 8, 9] } // Disable sorting on action columns
            ]
        });
    });
</script>


{% include 'footer.html' %}

    </body>
</html>